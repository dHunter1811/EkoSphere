{% extends 'core/base.html' %}
{% load static %}

{% block content %}

<style>
    /* ... (CSS Peta Ekspedisi Anda - tidak berubah) ... */
    .expedition-map { position: relative; padding-left: 40px; }
    .expedition-map::before { content: ''; position: absolute; left: 58px; top: 20px; bottom: 20px; width: 4px; background-color: #e0e0e0; z-index: 1; }
    .step { position: relative; margin-bottom: 20px; z-index: 2; }
    .step-icon { position: absolute; left: -20px; top: 50%; transform: translateY(-50%); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold; border: 4px solid #fff; }
    .step-content { padding: 1rem 1.5rem; border-radius: 10px; background-color: #fff; border: 2px solid #e0e0e0; transition: all 0.3s ease; }
    .step.completed .step-icon { background-color: #198754; color: white; }
    .step.completed .step-content { background-color: #f8f9fa; border-color: #d1d1d1; }
    .step.completed .step-content a { color: #212529; }
    .step.current .step-icon { background-color: #0d6efd; color: white; }
    .step.current .step-content { border-color: #0d6efd; background-color: #f0f7ff; box-shadow: 0 4px 15px rgba(13, 110, 253, 0.15); }
    .step.current .step-content a { font-weight: bold; color: #0d6efd; }
    .step.locked .step-icon { background-color: #adb5bd; color: #f8f9fa; }
    .step.locked .step-content { background-color: #f8f9fa; border-style: dashed; }
    .step.locked .step-content a { color: #6c757d; pointer-events: none; text-decoration: none; }

    /* CSS Kartu Arena Baru */
    .arena-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        height: 100%;
        border: none;
        position: relative;
        overflow: hidden; /* Pastikan isi tidak keluar radius */
        border-radius: 10px; /* Konsisten dengan gambar */
    }
    .arena-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
    }
    .arena-card-img {
        height: 120px; /* Sesuaikan tinggi gambar agar proporsional */
        width: 100%;
        object-fit: cover;
        border-radius: 10px 10px 0 0;
    }
    
    /* Gaya Kartu Terkunci (DIPERBAIKI) */
    .arena-card.locked {
        opacity: 0.9; /* Sedikit transparan tapi gambar tetap jelas */
    }
    .arena-card.locked:hover {
        transform: none;
        box-shadow: none !important;
        cursor: not-allowed;
    }
    
    /* Overlay Gembok (DIPERBAIKI) */
    .lock-overlay {
        position: absolute;
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 120px; /* Samakan dengan tinggi .arena-card-img */
        background: rgba(0, 0, 0, 0.4); /* Hitam transparan */
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px 10px 0 0;
        color: white;
        font-size: 2.5rem;
        z-index: 10;
        backdrop-filter: blur(2px); /* Efek blur sedikit pada gambar di belakang gembok */
    }
</style>

<div class="p-4 mb-4 bg-white rounded-3 shadow-sm text-dark">
    <div class="row align-items-center">
        <div class="col-md-7">
            <h1 class="display-6 fw-bold mb-3">Selamat Datang di EkoSphere!</h1>
            <p class="fs-4 text-muted">Media Pembelajaran Interaktif untuk Ekosistem Lahan Basah.</p>
        </div>
        <div class="col-md-5 text-center text-md-end mt-3 mt-md-0">
            <img src="{% static 'images/header.png' %}"
                 alt="Ilustrasi EkoSphere"
                 class="img-fluid rounded-3"
                 style="max-height: 200px; width: auto; object-fit: contain;">
        </div>
    </div>
</div>

<div class="mb-4">
    <h3 class="text-dark mb-3"><i class="bi bi-binoculars-fill text-success"></i> Jelajahi Penghuni Lahan Basah</h3>
    <style>
        #penghuniSlider .carousel-control-prev, #penghuniSlider .carousel-control-next { background-color: rgba(0, 0, 0, 0.4); width: 40px; height: 40px; border-radius: 50%; top: 50%; transform: translateY(-50%); }
        #penghuniSlider .carousel-control-prev { left: 1rem; } #penghuniSlider .carousel-control-next { right: 1rem; }
    </style>
    <div id="penghuniSlider" class="carousel slide" data-bs-ride="carousel" data-bs-interval="5000">
        <div class="carousel-inner">
            {% for item in info_items %}
                {% if forloop.counter0|divisibleby:3 %}
                <div class="carousel-item {% if forloop.first %}active{% endif %}">
                    <div class="row g-3">
                {% endif %}
                <div class="col-md-4 mb-3">
                    <div class="card shadow-sm h-100 text-dark">
                        <img src="{{ item.gambar_url }}" class="card-img-top" alt="{{ item.nama }}" style="height: 180px; object-fit: cover;">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">{{ item.nama }}</h5>
                            <p class="card-text text-muted">{{ item.deskripsi_singkat }}</p>
                        </div>
                    </div>
                </div>
                {% if forloop.counter|divisibleby:3 or forloop.last %}
                    </div> </div>
                {% endif %}
            {% empty %}
                <div class="carousel-item active">
                    <div class="d-flex justify-content-center align-items-center" style="height: 250px; background-color: #f8f9fa;">
                        <p class="text-muted fs-5">Konten "Jelajahi Penghuni" belum ditambahkan di Admin Panel.</p>
                    </div>
                </div>
            {% endfor %}
        </div>
        {% if info_items.count > 3 %}
        <button class="carousel-control-prev" type="button" data-bs-target="#penghuniSlider" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span><span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#penghuniSlider" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span><span class="visually-hidden">Next</span>
        </button>
        {% endif %}
    </div>
</div>

<div class="row text-dark">
    <div class="col-lg-7 mb-4 d-flex flex-column">
        
        <div class="card shadow-sm mb-4 flex-grow-1"> 
            <div class="card-header bg-success text-white">
                <h4 class="mb-0"><i class="bi bi-map-fill"></i> Ekspedisi Rawa Gambut</h4>
            </div>
            <div class="card-body">
                <div class="expedition-map">
                    {% for subtopik in daftar_materi %}
                        {% if subtopik.id in completed_materi_ids %}
                            {% with status="completed" icon="bi-check-lg" %}
                            <div class="step {{ status }}">
                                <div class="step-icon"><i class="bi {{ icon }}"></i></div>
                                <div class="step-content shadow-sm">
                                    <a href="{% url 'subtopik_detail' pk=subtopik.pk %}" class="text-decoration-none d-block">
                                        <h5 class="card-title mb-1">{{ subtopik.judul }}</h5>
                                        <p class="card-text text-muted mb-0">{{ subtopik.topik.judul }}</p>
                                    </a>
                                </div>
                            </div>
                            {% endwith %}
                        {% elif subtopik.pk == first_unlocked_pk %}
                            {% with status="current" icon="bi-play-fill" %}
                            <div class="step {{ status }}">
                                <div class="step-icon"><i class="bi {{ icon }}"></i></div>
                                <div class="step-content shadow-sm">
                                    <a href="{% url 'subtopik_detail' pk=subtopik.pk %}" class="text-decoration-none d-block">
                                        <h5 class="card-title mb-1">{{ subtopik.judul }}</h5>
                                        <p class="card-text text-muted mb-0">{{ subtopik.topik.judul }}</p>
                                    </a>
                                </div>
                            </div>
                            {% endwith %}
                        {% else %}
                            {% with status="locked" icon="bi-lock-fill" %}
                            <div class="step {{ status }}">
                                <div class="step-icon"><i class="bi {{ icon }}"></i></div>
                                <div class="step-content shadow-sm">
                                    <a href="#" class="text-decoration-none d-block">
                                        <h5 class="card-title mb-1">{{ subtopik.judul }}</h5>
                                        <p class="card-text text-muted mb-0">{{ subtopik.topik.judul }}</p>
                                    </a>
                                </div>
                            </div>
                            {% endwith %}
                        {% endif %}
                    {% empty %}
                        <p class="text-muted p-3">Belum ada materi ekspedisi yang tersedia.</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="mb-4">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <h5 class="mb-0 fw-bold text-dark"><i class="bi bi-controller me-2"></i>Zona Arena</h5>
            </div>
            
            <div class="row row-cols-2 row-cols-xl-4 g-3">
                
                <div class="col">
                    {% if arena_status.klasifikasi.locked %}
                        <div class="card shadow-sm arena-card locked h-100" onclick="aksesTerkunci('{{ arena_status.klasifikasi.materi_judul }}', '{{ arena_status.klasifikasi.materi_pk }}')">
                            <div class="position-relative">
                                <img src="{% static 'images/cover_klasifikasi.png' %}" class="arena-card-img" alt="Klasifikasi">
                                <div class="lock-overlay"><i class="bi bi-lock-fill"></i></div>
                            </div>
                            <div class="card-body p-3 d-flex flex-column">
                                <h6 class="card-title fw-bold text-muted small mb-1">Klasifikasi</h6>
                                <p class="card-text text-muted small mb-2 flex-grow-1" style="font-size: 0.75rem;">Selesaikan Materi 1.1</p>
                                <button class="btn btn-sm btn-secondary w-100 rounded-pill py-0">Terkunci</button>
                            </div>
                        </div>
                    {% else %}
                        <div class="card shadow-sm arena-card h-100">
                            <img src="{% static 'images/cover_klasifikasi.png' %}" class="arena-card-img" alt="Klasifikasi">
                            <div class="card-body p-3 d-flex flex-column">
                                <h6 class="card-title fw-bold text-success small mb-1">Klasifikasi</h6>
                                <p class="card-text text-muted small mb-2 flex-grow-1" style="font-size: 0.75rem;">Biotik vs Abiotik.</p>
                                <a href="{% url 'klasifikasi_arena' %}" class="btn btn-sm btn-success w-100 rounded-pill py-0">Main</a>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <div class="col">
                    {% if arena_status.interaksi.locked %}
                        <div class="card shadow-sm arena-card locked h-100" onclick="aksesTerkunci('{{ arena_status.interaksi.materi_judul }}', '{{ arena_status.interaksi.materi_pk }}')">
                            <div class="position-relative">
                                <img src="{% static 'images/cover_simbiosis.png' %}" class="arena-card-img" alt="Simbiosis">
                                <div class="lock-overlay"><i class="bi bi-lock-fill"></i></div>
                            </div>
                            <div class="card-body p-3 d-flex flex-column">
                                <h6 class="card-title fw-bold text-muted small mb-1">Simbiosis</h6>
                                <p class="card-text text-muted small mb-2 flex-grow-1" style="font-size: 0.75rem;">Selesaikan Materi 1.2</p>
                                <button class="btn btn-sm btn-secondary w-100 rounded-pill py-0">Terkunci</button>
                            </div>
                        </div>
                    {% else %}
                        <div class="card shadow-sm arena-card h-100">
                            <img src="{% static 'images/cover_simbiosis.png' %}" class="arena-card-img" alt="Simbiosis">
                            <div class="card-body p-3 d-flex flex-column">
                                <h6 class="card-title fw-bold text-warning small mb-1">Simbiosis</h6>
                                <p class="card-text text-muted small mb-2 flex-grow-1" style="font-size: 0.75rem;">Tebak hubungan.</p>
                                <a href="{% url 'duel_simbiosis' %}?dari=dashboard" class="btn btn-sm btn-warning w-100 rounded-pill py-0 text-dark">Main</a>
                            </div>
                        </div>
                    {% endif %}
                </div>

                 <div class="col">
                    {% if arena_status.interaksi.locked %}
                        <div class="card shadow-sm arena-card locked h-100" onclick="aksesTerkunci('{{ arena_status.interaksi.materi_judul }}', '{{ arena_status.interaksi.materi_pk }}')">
                            <div class="position-relative">
                                <img src="{% static 'images/cover_predator.png' %}" class="arena-card-img" alt="Predator">
                                <div class="lock-overlay"><i class="bi bi-lock-fill"></i></div>
                            </div>
                            <div class="card-body p-3 d-flex flex-column">
                                <h6 class="card-title fw-bold text-muted small mb-1">Predator</h6>
                                <p class="card-text text-muted small mb-2 flex-grow-1" style="font-size: 0.75rem;">Selesaikan Materi 1.2</p>
                                <button class="btn btn-sm btn-secondary w-100 rounded-pill py-0">Terkunci</button>
                            </div>
                        </div>
                    {% else %}
                        <div class="card shadow-sm arena-card h-100">
                            <img src="{% static 'images/cover_predator.png' %}" class="arena-card-img" alt="Predator">
                            <div class="card-body p-3 d-flex flex-column">
                                <h6 class="card-title fw-bold text-danger small mb-1">Predator</h6>
                                <p class="card-text text-muted small mb-2 flex-grow-1" style="font-size: 0.75rem;">Pecahkan kasus.</p>
                                <a href="{% url 'jejak_predator' %}" class="btn btn-sm btn-danger w-100 rounded-pill py-0">Main</a>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <div class="col">
                    {% if arena_status.energi.locked %}
                        <div class="card shadow-sm arena-card locked h-100" onclick="aksesTerkunci('{{ arena_status.energi.materi_judul }}', '{{ arena_status.energi.materi_pk }}')">
                            <div class="position-relative">
                                <img src="{% static 'images/cover_energy.png' %}" class="arena-card-img" alt="Energi">
                                <div class="lock-overlay"><i class="bi bi-lock-fill"></i></div>
                            </div>
                            <div class="card-body p-3 d-flex flex-column">
                                <h6 class="card-title fw-bold text-muted small mb-1">Energy Flow</h6>
                                <p class="card-text text-muted small mb-2 flex-grow-1" style="font-size: 0.75rem;">Selesaikan Materi 1.3</p>
                                <button class="btn btn-sm btn-secondary w-100 rounded-pill py-0">Terkunci</button>
                            </div>
                        </div>
                    {% else %}
                        <div class="card shadow-sm arena-card h-100">
                            <img src="{% static 'images/cover_energy.png' %}" class="arena-card-img" alt="Energi">
                            <div class="card-body p-3 d-flex flex-column">
                                <h6 class="card-title fw-bold text-info small mb-1">Energy Flow</h6>
                                <p class="card-text text-muted small mb-2 flex-grow-1" style="font-size: 0.75rem;">Rantai makanan.</p>
                                <a href="{% url 'energy_flow_arena' %}" class="btn btn-sm btn-info w-100 rounded-pill py-0 text-white">Main</a>
                            </div>
                        </div>
                    {% endif %}
                </div>

            </div>
        </div>
        </div>
    
    <div class="col-lg-5 mb-4 d-flex flex-column">
        
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold"><i class="bi bi-trophy-fill me-2"></i>Papan Peringkat Teratas</h5>
                <a href="{% url 'leaderboard' %}" class="btn btn-sm btn-dark">Lihat Semua <i class="bi bi-arrow-right-short"></i></a>
            </div>
            <div class="card-body p-0">
                <ul class="list-group list-group-flush rounded-bottom">
                    {% for profil in siswa_teratas %}
                    <li class="list-group-item d-flex justify-content-between align-items-center py-3" 
                        style="{% if forloop.counter <= 3 %}background-color: #fffbf0;{% endif %}">
                        <div class="d-flex align-items-center">
                            {% if forloop.counter == 1 %}
                                <img src="{% static 'images/badges/gold_badge.png' %}" alt="Emas" style="width: 32px; height: 32px; object-fit: contain;" class="me-3">
                            {% elif forloop.counter == 2 %}
                                <img src="{% static 'images/badges/silver_badge.png' %}" alt="Perak" style="width: 32px; height: 32px; object-fit: contain;" class="me-3">
                            {% elif forloop.counter == 3 %}
                                <img src="{% static 'images/badges/bronze_badge.png' %}" alt="Perunggu" style="width: 32px; height: 32px; object-fit: contain;" class="me-3">
                            {% endif %}
                            <span class="fw-bold fs-5">{{ profil.user.username }}</span>
                        </div>
                        <span class="badge rounded-pill px-3 py-2 fs-6 {% if forloop.counter <= 3 %}bg-success{% else %}bg-secondary{% endif %}">
                            {{ profil.total_poin }} Poin
                        </span>
                    </li>
                    {% empty %}
                    <li class="list-group-item text-center text-muted py-4">Belum ada data peringkat.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        
        <div class="card shadow-sm mb-4 border-0 overflow-hidden">
            <div class="row g-0 h-100">
                <div class="col-3 bg-dark d-flex align-items-center justify-content-center">
                    <i class="bi bi-book-half text-white fs-1"></i>
                </div>
                <div class="col-9">
                    <div class="card-body py-2 px-3">
                        <h6 class="card-title fw-bold text-dark mb-1">Buku Referensi</h6>
                        <p class="card-text small text-muted mb-2" style="font-size: 0.85rem;">
                            Sumber bacaan dan literatur tambahan.
                        </p>
                        <a href="{% url 'referensi' %}" class="btn btn-sm btn-outline-dark w-100 rounded-pill py-0 mt-1">Buka Pustaka <i class="bi bi-arrow-right"></i></a>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-body text-center py-3">
                <h5 class="card-title mb-2"><i class="bi bi-flag-fill text-danger"></i> Ujian Akhir</h5>
                {% if semua_materi_selesai %}
                    <a href="{% url 'ujian_akhir' %}" class="btn btn-outline-danger w-100 fw-bold btn-sm">Mulai Ujian</a>
                {% else %}
                    <button class="btn btn-secondary w-100 btn-sm" disabled><i class="bi bi-lock-fill"></i> Terkunci</button>
                {% endif %}
            </div>
        </div>

        <div class="card shadow-sm flex-grow-1 border-0">
            <div class="card-header bg-white border-0 pt-3 pb-0 d-flex justify-content-between align-items-center">
                <ul class="nav nav-pills card-header-pills" id="progressTab" role="tablist">
                    <li class="nav-item me-1">
                        <button class="nav-link active btn-sm py-1 px-3 fw-bold rounded-pill" id="lencana-tab" data-bs-toggle="tab" data-bs-target="#lencana" type="button" role="tab" style="font-size: 0.85rem;">
                            <i class="bi bi-award-fill me-1"></i> Lencana
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link btn-sm py-1 px-3 fw-bold rounded-pill" id="riwayat-tab" data-bs-toggle="tab" data-bs-target="#riwayat" type="button" role="tab" style="font-size: 0.85rem;">
                            <i class="bi bi-clock-history me-1"></i> Riwayat
                        </button>
                    </li>
                </ul>
                <a href="{% url 'progres' %}" class="text-decoration-none small fw-bold">Detail ></a>
            </div>
            <div class="card-body p-0">
                <div class="tab-content" id="progressTabContent">
                    <div class="tab-pane fade show active" id="lencana" role="tabpanel">
                        <ul class="list-group list-group-flush">
                            {% for lencana in profil_siswa.lencana.all %}
                            <li class="list-group-item d-flex align-items-center border-0 py-2">
                                <img src="{{ lencana.gambar_url }}" alt="{{ lencana.nama }}" width="50" class="me-3">
                                <span class="small">
                                    <strong>{{ lencana.nama }}</strong>
                                </span>
                            </li>
                            {% empty %}
                            <li class="list-group-item text-muted text-center py-4 small">Belum ada lencana.</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="tab-pane fade" id="riwayat" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-0 align-middle">
                                <thead class="table-light">
                                    <tr><th class="ps-3 small">Kuis</th><th class="text-end pe-3 small">Skor</th></tr>
                                </thead>
                                <tbody>
                                    {% for hasil in hasil_kuis_list %}
                                    <tr>
                                        <td class="ps-3 small">{{ hasil.kuis.judul|truncatechars:15 }}</td>
                                        <td class="text-end pe-3"><span class="badge {% if hasil.skor >= 75 %}bg-success{% else %}bg-warning text-dark{% endif %}">{{ hasil.skor|floatformat:0 }}</span></td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="2" class="text-center text-muted py-3 small">Kosong.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Fungsi untuk menangani klik pada arena terkunci
    function aksesTerkunci(judulMateri, pkMateri) {
        if (confirm(`Arena ini terkunci. Anda harus menyelesaikan materi "${judulMateri}" terlebih dahulu. Apakah Anda ingin menuju materi tersebut sekarang?`)) {
            if (pkMateri && pkMateri !== 'None') {
                window.location.href = `/materi/${pkMateri}/`;
            } else {
                alert("Maaf, materi belum tersedia.");
            }
        }
    }
</script>

{% endblock %}