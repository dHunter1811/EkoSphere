{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<style>
    /* Membatalkan Sticky Footer */
    body { display: block !important; height: auto !important; min-height: 0 !important; }
    main.container { flex-grow: 0 !important; padding-top: 2rem !important; padding-bottom: 2rem !important; }

    /* CSS Menu Level - NUANSA MERAH */
    #level-select-screen {
        background-color: #fff; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05);
    }
    .level-grid {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;
    }
    .level-box {
        /* Merah Muda */
        background-color: #f8d7da; 
        border: 2px solid #f5c6cb;
        color: #842029; /* Teks Merah Gelap */
        
        border-radius: 10px; padding: 1.5rem;
        font-size: 1.2rem; font-weight: bold; text-align: center; cursor: pointer;
        transition: all 0.2s ease; display: flex; flex-direction: column; align-items: center;
    }
    .level-box:hover { 
        background-color: #f1aeb5; 
        border-color: #dc3545; 
        transform: translateY(-3px); 
    }
    .level-box i { 
        font-size: 2rem; 
        margin-bottom: 0.5rem; 
        color: #dc3545; /* Ikon Merah */
    }

    /* CSS Game Screen */
    #game-screen { visibility: hidden; opacity: 0; transition: opacity 0.3s ease-in-out; }
    #game-screen.show { visibility: visible; opacity: 1; }
    #level-select-screen.hide { display: none; }

    .arena-illustration {
        background-size: cover; background-position: center center;
        min-height: 400px; border-radius: 15px 0 0 15px;
        transition: background-image 0.5s ease-in-out;
    }
    .arena-container {
        display: flex; align-items: center; justify-content: center;
        padding: 2rem; background-color: #ffffff;
    }
    .game-card { width: 100%; }
    
    /* Header Merah */
    .game-card .card-header { 
        background-color: #dc3545; /* Merah Danger */
        color: #fff; 
        border: none; padding: 1rem 1.5rem; 
    }

    /* Tombol Jawaban */
    .answer-btn {
        font-size: 1.1rem; padding: 0.8rem 1rem;
        border: 2px solid #e0e0e0; transition: all 0.2s ease; text-align: left;
    }
    .answer-btn:hover { 
        background-color: #f8f9fa; 
        border-color: #dc3545; /* Border merah saat hover */
    }
    .answer-btn.btn-success { background-color: #198754 !important; border-color: #198754 !important; color: white !important; }
    .answer-btn.btn-danger { background-color: #dc3545 !important; border-color: #dc3545 !important; color: white !important; }

    @media (max-width: 767px) {
        .arena-illustration { min-height: 200px; border-radius: 15px 15px 0 0; }
        .arena-container { border-radius: 0 0 15px 15px; }
    }
</style>

<div class="container text-dark my-5">

    <div id="level-select-screen" class="p-4 p-md-5">
        <div class="text-center mb-4">
            <h1 class="display-5 fw-bold text-danger">Arena: Jejak Predator</h1>
            <p class="fs-4 text-muted">Ikuti jejak dan pecahkan misteri rantai makanan.</p>
        </div>
        
        <div class="level-grid" id="level-grid-container">
            </div>
        
        <div class="text-center mt-5 d-flex justify-content-center gap-2">
            {% if sumber_akses == 'dashboard' %}
                <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-house-door-fill me-1"></i> Dashboard
                </a>
            {% elif materi_asal_pk %}
                <a href="{% url 'subtopik_detail' pk=materi_asal_pk %}" class="btn btn-outline-danger">
                    <i class="bi bi-book-half me-1"></i> Kembali ke Materi
                </a>
            {% else %}
                <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Kembali
                </a>
            {% endif %}
        </div>
    </div>

    <div id="game-screen" class="">
        <div class="card shadow-lg border-0" style="border-radius: 15px; overflow: hidden;">
            <div class="row g-0">
                
                <div class="col-md-5 d-none d-md-block arena-illustration" id="game-illustration"></div>

                <div class="col-md-7 col-12 arena-container">
                    <div class="game-card">
                        
                        <div class="card-header text-center">
                            <h2 id="story-title" class="fw-bold mb-0">...</h2>
                        </div>
                        
                        <div class="card-body p-4 p-md-5">
                            
                            <div id="game-content">
                                <blockquote class="blockquote text-center border-start border-4 border-danger ps-3 mb-4" style="min-height: 100px;">
                                    <p id="story-text" class="fs-5 fst-italic">Memuat...</p>
                                </blockquote>

                                <div id="interaction-area">
                                    <div id="continue-btn-area" class="d-grid">
                                        <button id="continue-btn" class="btn btn-danger text-white fw-bold">Lanjutkan <i class="bi bi-arrow-right"></i></button>
                                    </div>
                                    
                                    <div id="question-area" class="d-none">
                                        <hr>
                                        <p id="question-text" class="fw-bold text-center my-3">...</p>
                                        <div id="answer-options" class="d-grid gap-2"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="hasil-container" class="d-none text-center">
                                <i class="bi bi-compass text-success display-1 mb-3"></i>
                                <h3 class="fw-bold">Misteri Terpecahkan!</h3>
                                <p class="fs-4">Skor Kasus Ini:</p>
                                <p id="skor-akhir" class="display-3 fw-bold text-danger"></p>
                                <div class="d-grid gap-2 d-md-block mt-4">
                                    <button id="back-to-menu-btn" class="btn btn-secondary">Pilih Kasus Lain</button>
                                </div>
                            </div>

                            <div class="mt-4 pt-3 border-top d-flex justify-content-center gap-2">
                                <a href="{% url 'dashboard' %}" class="btn btn-sm btn-outline-dark">
                                    <i class="bi bi-house-door-fill"></i> Dashboard
                                </a>
                                {% if materi_asal_pk %}
                                <a href="{% url 'subtopik_detail' pk=materi_asal_pk %}" class="btn btn-sm btn-outline-danger">
                                    <i class="bi bi-book-half"></i> Materi
                                </a>
                                {% endif %}
                            </div>

                        </div>
                        
                        <div class="card-footer bg-white border-0 p-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span id="progress-text" class="text-muted small">Langkah 1 dari ...</span>
                                <span class="text-muted small">Total Poin: <strong id="poin-display" class="text-danger">{{ profil_siswa.total_poin|default:0 }}</strong></span>
                            </div>
                            
                            <div class="progress" style="height: 10px;">
                                <div id="progress-bar" class="progress-bar bg-danger" role="progressbar" style="width: 0%;"></div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const gameData = {{ game_data_json|safe }};
        let currentLevelIndex = 0;
        let currentStepIndex = 0;
        let levelScore = 0;
        let totalPoinServer = {{ profil_siswa.total_poin|default:0 }};

        // UI Elements
        const levelSelectScreen = document.getElementById('level-select-screen');
        const gameScreen = document.getElementById('game-screen');
        const levelGridContainer = document.getElementById('level-grid-container');
        
        const storyTitle = document.getElementById('story-title');
        const illustrationEl = document.getElementById('game-illustration');
        const gameContent = document.getElementById('game-content');
        const storyText = document.getElementById('story-text');
        const interactionArea = document.getElementById('interaction-area');
        const questionArea = document.getElementById('question-area');
        const questionText = document.getElementById('question-text');
        const answerOptions = document.getElementById('answer-options');
        const continueBtnArea = document.getElementById('continue-btn-area');
        const continueBtn = document.getElementById('continue-btn');
        
        const hasilContainer = document.getElementById('hasil-container');
        const skorAkhirEl = document.getElementById('skor-akhir');
        const backToMenuBtn = document.getElementById('back-to-menu-btn');
        
        const progressText = document.getElementById('progress-text');
        const progressBar = document.getElementById('progress-bar');
        const poinDisplay = document.getElementById('poin-display');

        // --- 1. Inisialisasi Menu Level ---
        function buildLevelGrid() {
            levelGridContainer.innerHTML = '';
            gameData.forEach((level, index) => {
                const btn = document.createElement('button');
                btn.className = 'level-box';
                btn.innerHTML = `
                    <i class="bi bi-search"></i> 
                    <span>Kasus ${level.level}</span>
                    <span class="small fw-normal text-muted mt-1">${level.title}</span>
                `;
                btn.onclick = () => startLevel(index);
                levelGridContainer.appendChild(btn);
            });
        }

        // --- 2. Mulai Level ---
        function startLevel(index) {
            currentLevelIndex = index;
            currentStepIndex = 0;
            levelScore = 0;

            // UI Transition
            levelSelectScreen.classList.add('hide');
            gameScreen.classList.add('show');
            gameContent.classList.remove('d-none');
            hasilContainer.classList.add('d-none');
            
            // Set Background
            const levelData = gameData[currentLevelIndex];
            if (illustrationEl) {
                illustrationEl.style.backgroundImage = `url('${levelData.image_url}')`;
            }
            storyTitle.innerText = levelData.title;

            loadStep();
        }

        // --- 3. Load Step Cerita/Soal ---
        function loadStep() {
            const levelData = gameData[currentLevelIndex];
            
            if (currentStepIndex >= levelData.steps.length) {
                finishLevel();
                return;
            }

            const step = levelData.steps[currentStepIndex];
            storyText.innerText = step.text;

            // Update Gambar per Langkah
            if (illustrationEl && step.image_url) {
                illustrationEl.style.backgroundImage = `url('${step.image_url}')`;
            }

            // Update Progress
            const totalSteps = levelData.steps.length;
            progressText.innerText = `Langkah ${currentStepIndex + 1} dari ${totalSteps}`;
            progressBar.style.width = `${((currentStepIndex) / totalSteps) * 100}%`;

            if (step.question) {
                // Tampilkan Soal
                continueBtnArea.classList.add('d-none');
                questionArea.classList.remove('d-none');
                questionText.innerText = step.question;
                answerOptions.innerHTML = '';

                step.options.forEach(option => {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-light answer-btn';
                    btn.innerText = option;
                    btn.onclick = () => checkAnswer(option, step.correct_answer, btn);
                    answerOptions.appendChild(btn);
                });
            } else {
                // Hanya Cerita -> Tampilkan Tombol Lanjut
                questionArea.classList.add('d-none');
                continueBtnArea.classList.remove('d-none');
            }
        }

        // --- 4. Event Tombol Lanjut ---
        continueBtn.onclick = () => {
            currentStepIndex++;
            loadStep();
        };

        // --- 5. Cek Jawaban ---
        function checkAnswer(chosenAnswer, correctAnswer, btnKlik) {
            const allBtn = answerOptions.querySelectorAll('button');
            allBtn.forEach(b => b.disabled = true);

            if (chosenAnswer === correctAnswer) {
                btnKlik.classList.add('btn-success');
                levelScore += 25; // Poin besar untuk misteri
                kirimPoinKeServer(25);
            } else {
                btnKlik.classList.add('btn-danger');
                allBtn.forEach(b => {
                    if (b.innerText === correctAnswer) b.classList.add('btn-success');
                });
            }

            setTimeout(() => {
                currentStepIndex++;
                loadStep();
            }, 2000);
        }

        // --- 6. Level Selesai ---
        function finishLevel() {
            gameContent.classList.add('d-none');
            hasilContainer.classList.remove('d-none');
            
            skorAkhirEl.innerText = levelScore;
            progressText.innerText = "Kasus Ditutup!";
            progressBar.style.width = "100%";
        }

        // --- 7. Navigasi ---
        backToMenuBtn.onclick = () => {
            gameScreen.classList.remove('show');
            levelSelectScreen.classList.remove('hide');
        };

        // --- 8. Kirim Poin ---
        function kirimPoinKeServer(poin) {
            fetch("{% url 'api_simpan_poin' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ 'poin_didapat': poin })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'sukses') {
                    totalPoinServer = data.total_poin_baru;
                    poinDisplay.innerText = totalPoinServer;
                }
            });
        }

        // Mulai
        buildLevelGrid();
    });
</script>
{% endblock %}