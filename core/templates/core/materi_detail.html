{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<div class="row text-dark mt-4">
    <div class="col-md-4 sidebar-container">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h4>Navigasi Materi</h4>
            </div>
            <div class="list-group list-group-flush">
                <a href="{% url 'dashboard' %}" class="list-group-item list-group-item-action bg-light fw-bold">
                    <i class="bi bi-arrow-left-square-fill"></i> Kembali ke Dashboard
                </a>
                {% for topik in semua_topik %}
                <div class="list-group-item">
                    <h6 class="mb-1 fw-bold">{{ topik.judul }}</h6>
                    <div class="list-group list-group-flush ps-2 mt-2">
                        {% for subtopik in topik.subtopik_set.all %}
                        
                        {% if subtopik.id in accessible_ids %}
                            <a href="{% url 'subtopik_detail' pk=subtopik.pk %}"
                                class="list-group-item list-group-item-action d-flex justify-content-between align-items-center {% if subtopik.id == subtopik_aktif.id %}active bg-success border-success{% endif %}">
                                <span>
                                    <small class="me-2">{% if subtopik.id == subtopik_aktif.id %}üìç{% else %}üìÑ{% endif %}</small>
                                    {{ subtopik.judul }}
                                </span>
                                {% if subtopik.id in completed_materi_ids %}
                                    <i class="bi bi-check-circle-fill text-success bg-white rounded-circle"></i>
                                {% endif %}
                            </a>
                        {% else %}
                            <div class="list-group-item d-flex justify-content-between align-items-center text-muted bg-light" style="cursor: not-allowed; opacity: 0.6;">
                                <span>
                                    <i class="bi bi-lock-fill me-2"></i>
                                    {{ subtopik.judul }}
                                </span>
                            </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
                
                <div class="p-3 mt-auto border-top">
                    <small class="fw-bold text-muted">Progres Misi (Kuis)</small>
                    <div class="progress mt-1" style="height: 10px;">
                        <div class="progress-bar bg-success" role="progressbar"
                            style="width: {{ progres_misi_persen }}%;" aria-valuenow="{{ progres_misi_persen }}"
                            aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-1 mb-2">
                        <small class="text-muted">{{ kuis_selesai_count }} dari {{ total_subtopik_misi }} kuis selesai.</small>
                        <small class="fw-bold text-success">{{ progres_misi_persen|floatformat:0 }}%</small>
                    </div>

                    {% if kuis_selesai_list %}
                        <div class="mt-3 pt-2 border-top">
                            <small class="text-muted d-block mb-1">Riwayat Penyelesaian:</small>
                            <ul class="list-group list-group-flush small">
                                {% for hasil in kuis_selesai_list %}
                                    <li class="list-group-item px-0 py-1 bg-transparent border-0 d-flex align-items-center">
                                        <i class="bi bi-check-circle-fill text-success me-2"></i>
                                        <span class="text-truncate w-75" title="{{ hasil.kuis.judul }}">{{ hasil.kuis.judul }}</span>
                                        <span class="badge bg-light text-dark ms-auto border">{{ hasil.skor|floatformat:0 }}</span>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                </div>

            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-body p-4">
                <h2 class="border-bottom pb-3 mb-4 fw-bold text-success">{{ subtopik_aktif.judul }}</h2>

                <div class="materi-content">
                    {{ subtopik_aktif.konten|safe }}
                </div>

                {% if subtopik_aktif.judul == "1.1: Mengenal Penghuni Lahan Basah" %}
                <div class="card text-dark mt-5 border-warning">
                    <div class="card-header bg-warning fw-bold">
                        <i class="bi bi-puzzle-fill me-2"></i> Uji Pemahaman Cepat: Klasifikasi Komponen
                    </div>
                    <div class="card-body">
                        <p>Seret setiap item di bawah ini ke dalam kotak yang benar, lalu tekan tombol "Cek Jawaban".</p>
                        <div id="items-container" class="d-flex flex-wrap gap-2 p-3 border rounded mb-3 bg-light justify-content-center" style="min-height: 80px;"></div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div id="biotik" class="p-4 border rounded bg-white text-center drop-zone shadow-sm h-100">
                                    <h5 class="text-success fw-bold"><i class="bi bi-tree-fill"></i> Biotik</h5>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div id="abiotik" class="p-4 border rounded bg-white text-center drop-zone shadow-sm h-100">
                                    <h5 class="text-info fw-bold"><i class="bi bi-cloud-sun-fill"></i> Abiotik</h5>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-4">
                            <button id="check-button" class="btn btn-primary px-4">Cek Jawaban</button>
                            <div id="result-container" class="mt-3 fw-bold"></div>
                        </div>
                    </div>
                </div>
                
                <div class="card border-primary shadow mt-4">
                    <div class="card-body text-center p-4">
                        <h4 class="card-title text-primary mb-3"><i class="bi bi-joystick"></i> Misi Tambahan</h4>
                        <p class="card-text">Perdalam pemahamanmu dengan tantangan interaktif di Arena.</p>
                        <a href="{% url 'klasifikasi_arena' %}" class="btn btn-primary btn-lg">
                            <i class="bi bi-play-fill"></i> Masuk ke Arena Interaktif
                        </a>
                    </div>
                </div>
                
                {% elif subtopik_aktif.judul == "1.2: Membedah Interaksi Makhluk Hidup di Rawa" %}
                <div class="card border-primary shadow mt-5">
                    <div class="card-body text-center p-4">
                        <h4 class="card-title text-primary mb-3"><i class="bi bi-joystick"></i> Misi Tambahan</h4>
                        <p class="card-text">Lanjutkan ekspedisi dengan simulasi interaksi makhluk hidup.</p>
                        <div class="d-flex justify-content-center gap-2">
                            <a href="{% url 'duel_simbiosis' %}" class="btn btn-primary btn-lg">
                                <i class="bi bi-lightning-fill"></i> Duel Simbiosis
                            </a>
                            <a href="{% url 'jejak_predator' %}" class="btn btn-warning btn-lg text-dark">
                                <i class="bi bi-search"></i> Jejak Predator
                            </a>
                        </div>
                    </div>
                </div>

                {% elif subtopik_aktif.judul == "1.3: Membangun Jaring-jaring Makanan Lahan Basah" %}
                <div class="card border-primary shadow mt-5">
                    <div class="card-body text-center p-4">
                        <h4 class="card-title text-primary mb-3"><i class="bi bi-joystick"></i> Misi Tambahan</h4>
                        <p class="card-text">Bangun rantai makananmu sendiri di simulasi ini.</p>
                        <a href="{% url 'energy_flow_arena' %}" class="btn btn-info btn-lg text-white">
                            <i class="bi bi-share-fill"></i> Simulasi Energy Flow
                        </a>
                    </div>
                </div>
                {% endif %}
                
                <hr class="my-5">
                
                <div class="text-center my-4">
                    {% if is_materi_selesai %}
                        <div class="alert alert-success d-inline-block px-4 py-2">
                            <i class="bi bi-check-circle-fill me-2"></i> Anda telah menyelesaikan materi ini.
                        </div>
                        <div class="mt-2">
                            <a href="{% url 'batalkan_materi_selesai' subtopik_aktif.pk %}" class="text-danger small text-decoration-none">
                                Batalkan Selesai
                            </a>
                        </div>
                    {% else %}
                        <p class="mb-3 text-muted">Silakan baca dan pahami materi di atas sebelum melanjutkan.</p>
                        
                        <button id="btn-timer" class="btn btn-secondary btn-lg px-4" disabled>
                            <i class="bi bi-hourglass-split"></i> Baca dulu... (<span id="countdown">60</span>s)
                        </button>

                        <a id="btn-selesai" href="{% url 'tandai_materi_selesai' subtopik_aktif.pk %}" class="btn btn-success btn-lg d-none animate__animated animate__pulse px-4">
                            ‚úÖ Tandai Telah Selesai
                        </a>

                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
                                let timeLeft = 60; 
                                const countdownEl = document.getElementById('countdown');
                                const btnTimer = document.getElementById('btn-timer');
                                const btnSelesai = document.getElementById('btn-selesai');

                                if(btnTimer && btnSelesai) {
                                    const timer = setInterval(function() {
                                        timeLeft--;
                                        if(countdownEl) countdownEl.innerText = timeLeft;

                                        if (timeLeft <= 0) {
                                            clearInterval(timer);
                                            btnTimer.classList.add('d-none');
                                            btnSelesai.classList.remove('d-none'); 
                                        }
                                    }, 1000);
                                }
                            });
                        </script>
                    {% endif %}
                </div>

            </div>

            <div class="card-footer d-flex justify-content-between align-items-center p-3 bg-light">
                
                {% if subtopik_sebelumnya %}
                <a href="{% url 'subtopik_detail' pk=subtopik_sebelumnya.pk %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Sebelumnya
                </a>
                {% else %}
                <button class="btn btn-outline-secondary" disabled><i class="bi bi-arrow-left"></i> Sebelumnya</button>
                {% endif %}
                
                {% if subtopik_aktif.kuis %}
                    {% if is_materi_selesai %}
                        <a href="{% url 'kuis' pk=subtopik_aktif.pk %}" class="btn btn-primary px-4">
                            {% if skor_tertinggi > 0 %} 
                                <i class="bi bi-arrow-repeat"></i> Ulangi Kuis (Skor: {{ skor_tertinggi|floatformat:0 }}) 
                            {% else %} 
                                <i class="bi bi-play-fill"></i> Mulai Kuis! 
                            {% endif %}
                        </a>
                    {% else %}
                        <span class="d-inline-block" tabindex="0" data-bs-toggle="tooltip" title="Tandai materi 'Telah Selesai' di atas untuk membuka kuis.">
                            <button class="btn btn-secondary" disabled>
                                <i class="bi bi-lock-fill"></i> Mulai Kuis
                            </button>
                        </span>
                    {% endif %}
                {% endif %}
                
                {% if subtopik_selanjutnya %}
                    {% if can_proceed %}
                        <a href="{% url 'subtopik_detail' pk=subtopik_selanjutnya.pk %}" class="btn btn-outline-primary">
                            Selanjutnya <i class="bi bi-arrow-right"></i>
                        </a>
                    {% else %}
                        <span class="d-inline-block" tabindex="0" data-bs-toggle="tooltip" title="Selesaikan materi ini dan lulus kuis (min 75) untuk lanjut.">
                            <button class="btn btn-outline-secondary" disabled>
                                <i class="bi bi-lock-fill"></i> Terkunci
                            </button>
                        </span>
                    {% endif %}
                {% else %}
                    <button class="btn btn-outline-secondary" disabled>Selanjutnya <i class="bi bi-arrow-right"></i></button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if subtopik_aktif.judul == "1.1: Mengenal Penghuni Lahan Basah" %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const itemsContainer = document.getElementById('items-container');
        const dropZones = document.querySelectorAll('.drop-zone');
        const checkButton = document.getElementById('check-button');
        const resultContainer = document.getElementById('result-container');
        let draggedItem = null;

        if (itemsContainer) {
            fetch("{% url 'api_klasifikasi' %}")
                .then(response => response.json())
                .then(data => {
                    if (data.items) {
                        data.items.forEach(itemData => {
                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'p-2 border rounded bg-white draggable-item fw-bold shadow-sm';
                            itemDiv.style.cursor = 'grab';
                            itemDiv.innerText = itemData.nama;
                            itemDiv.draggable = true;
                            itemDiv.dataset.type = itemData.tipe;
                            itemsContainer.appendChild(itemDiv);
                            itemDiv.addEventListener('dragstart', function (e) {
                                draggedItem = e.target;
                                e.target.style.opacity = '0.5';
                            });
                            itemDiv.addEventListener('dragend', function (e) {
                                e.target.style.opacity = '1';
                            });
                        });
                    }
                });

            dropZones.forEach(zone => {
                zone.addEventListener('dragover', e => {
                    e.preventDefault();
                    zone.classList.add('bg-light-subtle'); // Efek visual saat drag
                });
                zone.addEventListener('dragleave', e => {
                    zone.classList.remove('bg-light-subtle');
                });
                zone.addEventListener('drop', e => {
                    e.preventDefault();
                    zone.classList.remove('bg-light-subtle');
                    if (draggedItem) {
                        zone.appendChild(draggedItem);
                        draggedItem = null;
                    }
                });
            });

            checkButton.addEventListener('click', function () {
                let totalBenar = 0;
                let totalItem = document.querySelectorAll('.draggable-item').length;

                dropZones.forEach(zone => {
                    const itemsInZone = zone.querySelectorAll('.draggable-item');
                    itemsInZone.forEach(item => {
                        if (item.dataset.type === zone.id) {
                            item.className = 'p-2 border rounded draggable-item fw-bold shadow-sm text-white bg-success border-success';
                            totalBenar++;
                        } else {
                            item.className = 'p-2 border rounded draggable-item fw-bold shadow-sm text-white bg-danger border-danger';
                        }
                    });
                });

                if (totalBenar === totalItem) {
                    resultContainer.innerHTML = '<span class="text-success"><i class="bi bi-check-circle-fill"></i> Hebat! Semua jawabanmu benar!</span>';
                } else {
                    resultContainer.innerHTML = `<span class="text-danger"><i class="bi bi-exclamation-triangle-fill"></i> Oops! Kamu benar ${totalBenar} dari ${totalItem} item. Coba perbaiki!</span>`;
                }
            });
        }
    });
</script>
{% elif subtopik_aktif.judul == "1.2: Membedah Interaksi Makhluk Hidup di Rawa" %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        if (!document.getElementById('infoBox')) {
            const infoBoxDiv = document.createElement('div');
            infoBoxDiv.id = 'infoBox';
            infoBoxDiv.className = 'alert alert-info text-center mt-4 shadow-sm';
            infoBoxDiv.style.display = 'none';
            document.querySelector('.col-md-8 .card-body').appendChild(infoBoxDiv);
        }

        document.querySelectorAll('.interaktif-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const infoBox = document.getElementById('infoBox');
                infoBox.style.display = 'block';
                infoBox.innerHTML = `<i class="bi bi-info-circle-fill me-2"></i> ${btn.dataset.info}`;
                infoBox.classList.add('animate__animated', 'animate__fadeIn');
                setTimeout(() => infoBox.classList.remove('animate__fadeIn'), 800);
            });
        });
    });
</script>
{% endif %}

{% endblock %}