{% extends 'core/base.html' %}

{% block content %}
<div class="row text-dark mt-4">
    <div class="col-md-4 sidebar-container">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h4>Navigasi Materi</h4>
            </div>
            <div class="list-group list-group-flush">
                <a href="{% url 'dashboard' %}" class="list-group-item list-group-item-action bg-light fw-bold">
                    <i class="bi bi-arrow-left-square-fill"></i> Kembali ke Dashboard
                </a>

                {% for topik in semua_topik %}
                <div class="list-group-item">
                    <h6 class="mb-1">{{ topik.judul }}</h6>
                    <div class="list-group list-group-flush ps-2">
                        {% for subtopik in topik.subtopik_set.all %}
                        <a href="{% url 'subtopik_detail' pk=subtopik.pk %}"
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-center {% if subtopik.id == subtopik_aktif.id %}active{% endif %}">

                            {{ subtopik.judul }}

                            {% if subtopik.id in completed_materi_ids %}
                            <i class="bi bi-check-circle-fill text-success" title="Telah Selesai"></i>
                            {% endif %}
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}

                <div class="p-3 mt-auto">
                    <hr>
                    <small>Progres Misi (Kuis)</small>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-success" role="progressbar"
                            style="width: {{ progres_misi_persen }}%;" aria-valuenow="{{ progres_misi_persen }}"
                            aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <small class="text-muted">{{ kuis_selesai_count }} dari {{ total_subtopik_misi }} kuis
                        selesai.</small>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <h2 class="border-bottom pb-2 mb-3">{{ subtopik_aktif.judul }}</h2>

                <div class="materi-content">
                    {{ subtopik_aktif.konten|safe }}
                </div>

                {% if subtopik_aktif.judul == "1.3: Membangun Jaring-jaring Makanan Lahan Basah" %}
                <div class="card text-dark mt-4">
                    <div class="card-header bg-info">
                        <h4 class="mb-0">Simulasi: Energy Flow Builder</h4>
                    </div>
                    <div class="card-body">
                        <div id="rantai-terbangun" class="alert alert-success text-center fs-5">Rantai Makanan: ...
                        </div>
                        <p id="instruksi-simulasi" class="text-center fw-bold">Ketuk organisme yang benar sesuai
                            instruksi.</p>
                        <div id="pilihan-organisme" class="d-flex justify-content-around p-3 border rounded"></div>
                    </div>
                </div>
                {% elif subtopik_aktif.judul == "1.1: Mengenal Penghuni Lahan Basah" %}
                <div class="card text-dark mt-4">
                    <div class="card-header bg-warning">
                        <h4 class="mb-0">Uji Pemahaman Cepat: Klasifikasi Komponen</h4>
                    </div>
                    <div class="card-body">
                        <p>Seret setiap item di bawah ini ke dalam kotak yang benar, lalu tekan tombol "Cek Jawaban".
                        </p>
                        <div id="items-container" class="d-flex flex-wrap p-2 border rounded mb-3"></div>
                        <div class="row">
                            <div class="col">
                                <div id="biotik" class="p-4 border rounded bg-light text-center drop-zone"
                                    style="min-height: 150px;">
                                    <h5>Biotik</h5>
                                </div>
                            </div>
                            <div class="col">
                                <div id="abiotik" class="p-4 border rounded bg-light text-center drop-zone"
                                    style="min-height: 150px;">
                                    <h5>Abiotik</h5>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-3"><button id="check-button" class="btn btn-primary">Cek
                                Jawaban</button>
                            <div id="result-container" class="mt-2 fw-bold"></div>
                        </div>
                    </div>
                </div>
                {% elif subtopik_aktif.judul == "1.2: Membedah Interaksi Makhluk Hidup di Rawa" %}
                <div class="accordion mt-4" id="accordionInteraksi">
                </div>
                <div class="text-center mt-4">
                    <a href="{% url 'duel_simbiosis' %}" class="btn btn-warning btn-lg shadow-sm">⚔️ Mulai Tantangan:
                        Duel Simbiosis!</a>
                </div>
                {% endif %}
                <hr>
                <div class="text-center my-4">
                    {% if is_materi_selesai %}
                    <p class="text-success fw-bold">Anda telah menyelesaikan materi ini.</p>
                    <a href="{% url 'batalkan_materi_selesai' subtopik_aktif.pk %}" class="btn btn-outline-danger">
                        Batalkan Selesai
                    </a>
                    {% else %}
                    <p>Setelah Anda memahami materi ini, tandai sebagai selesai.</p>
                    <a href="{% url 'tandai_materi_selesai' subtopik_aktif.pk %}" class="btn btn-success btn-lg">
                        ✅ Tandai Telah Selesai
                    </a>
                    {% endif %}
                </div>

            </div>

            <div class="card-footer d-flex justify-content-between align-items-center">
                {% if subtopik_sebelumnya %}
                <a href="{% url 'subtopik_detail' pk=subtopik_sebelumnya.pk %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Sebelumnya
                </a>
                {% else %}
                <a href="#" class="btn btn-secondary disabled"><i class="bi bi-arrow-left"></i> Sebelumnya</a>
                {% endif %}

                {% if subtopik_aktif.kuis %}
                <a href="{% url 'kuis' pk=subtopik_aktif.pk %}" class="btn btn-primary btn-lg mx-3">Mulai Kuis!</a>
                {% endif %}

                {% if subtopik_selanjutnya %}
                <a href="{% url 'subtopik_detail' pk=subtopik_selanjutnya.pk %}" class="btn btn-secondary">
                    Selanjutnya <i class="bi bi-arrow-right"></i>
                </a>
                {% else %}
                <a href="#" class="btn btn-secondary disabled">Selanjutnya <i class="bi bi-arrow-right"></i></a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if subtopik_aktif.judul == "1.1: Mengenal Penghuni Lahan Basah" %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const itemsContainer = document.getElementById('items-container');
        const dropZones = document.querySelectorAll('.drop-zone');
        const checkButton = document.getElementById('check-button');
        const resultContainer = document.getElementById('result-container');
        let draggedItem = null;

        fetch("{% url 'api_klasifikasi' %}")
            .then(response => response.json())
            .then(data => {
                if (data.items) {
                    data.items.forEach(itemData => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'p-2 m-1 border rounded bg-white draggable-item';
                        itemDiv.innerText = itemData.nama;
                        itemDiv.draggable = true;
                        itemDiv.dataset.type = itemData.tipe;
                        itemsContainer.appendChild(itemDiv);
                        itemDiv.addEventListener('dragstart', function (e) {
                            draggedItem = e.target;
                        });
                    });
                }
            });

        dropZones.forEach(zone => {
            zone.addEventListener('dragover', e => e.preventDefault());
            zone.addEventListener('drop', e => {
                e.preventDefault();
                if (draggedItem) {
                    zone.appendChild(draggedItem);
                    draggedItem = null;
                }
            });
        });

        checkButton.addEventListener('click', function () {
            let totalBenar = 0;
            let totalItem = document.querySelectorAll('.draggable-item').length;

            dropZones.forEach(zone => {
                const itemsInZone = zone.querySelectorAll('.draggable-item');
                itemsInZone.forEach(item => {
                    if (item.dataset.type === zone.id) {
                        item.style.backgroundColor = '#d4edda';
                        totalBenar++;
                    } else {
                        item.style.backgroundColor = '#f8d7da';
                    }
                });
            });

            if (totalBenar === totalItem) {
                resultContainer.innerHTML = '<span class="text-success">Hebat! Semua jawabanmu benar!</span>';
            } else {
                resultContainer.innerHTML = `<span class="text-danger">Oops! Kamu benar ${totalBenar} dari ${totalItem} item. Coba perbaiki!</span>`;
            }
        });
    });
</script>
{% elif subtopik_aktif.judul == "1.3: Membangun Jaring-jaring Makanan Lahan Basah" %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const apiURL = "{% url 'api_rantai_makanan' %}";
        const instruksiEl = document.getElementById('instruksi-simulasi');
        const pilihanEl = document.getElementById('pilihan-organisme');
        const rantaiEl = document.getElementById('rantai-terbangun');

        let semuaOrganisme = [];
        let rantaiMakanan = [];
        let langkahSaatIni = 0;

        const instruksiTeks = [
            "Ketuk organisme yang berperan sebagai Produsen.",
            "Ketuk organisme yang memakan Produsen (Konsumen I).",
            "Ketuk organisme yang memakan Konsumen I (Konsumen II).",
            "Ketuk organisme yang memakan Konsumen II (Konsumen III)."
        ];

        fetch(apiURL)
            .then(response => response.json())
            .then(data => {
                semuaOrganisme = data.organisme;
                mulaiSimulasi();
            });

        function mulaiSimulasi() {
            langkahSaatIni = 0;
            rantaiMakanan = [];
            updateTampilan();
        }

        function updateTampilan() {
            instruksiEl.innerText = instruksiTeks[langkahSaatIni];
            pilihanEl.innerHTML = '';

            semuaOrganisme.forEach(org => {
                const orgButton = document.createElement('button');
                orgButton.className = 'btn btn-outline-success';
                orgButton.innerText = org.nama;
                orgButton.dataset.id = org.id;

                if (rantaiMakanan.find(r => r.id === org.id)) {
                    orgButton.disabled = true;
                }

                orgButton.addEventListener('click', function () {
                    cekJawaban(org);
                });
                pilihanEl.appendChild(orgButton);
            });

            rantaiEl.innerText = 'Rantai Makanan: ' + rantaiMakanan.map(r => r.nama).join(' → ');
        }

        function cekJawaban(organisme) {
            let jawabanBenar = false;
            if (langkahSaatIni === 0 && organisme.tipe === 'produsen') {
                jawabanBenar = true;
            }
            else if (langkahSaatIni > 0) {
                const organismeSebelumnya = rantaiMakanan[langkahSaatIni - 1];
                if (organisme.memakan.includes(organismeSebelumnya.id)) {
                    jawabanBenar = true;
                }
            }

            if (jawabanBenar) {
                rantaiMakanan.push(organisme);
                langkahSaatIni++;
                if (langkahSaatIni >= instruksiTeks.length) {
                    instruksiEl.innerText = "Selamat! Rantai makanan berhasil dibangun!";
                    pilihanEl.innerHTML = '<button id="reset-btn" class="btn btn-primary">Ulangi Simulasi</button>';
                    document.getElementById('reset-btn').addEventListener('click', mulaiSimulasi);
                } else {
                    updateTampilan();
                }
            } else {
                alert('Pilihan kurang tepat, coba lagi!');
            }
        }
    });
</script>
{% endif %}

{% endblock %}