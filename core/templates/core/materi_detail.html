{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<div class="row text-dark mt-4">
    <div class="col-md-4 sidebar-container">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h4>Navigasi Materi</h4>
            </div>
            <div class="list-group list-group-flush">
                <a href="{% url 'dashboard' %}" class="list-group-item list-group-item-action bg-light fw-bold">
                    <i class="bi bi-arrow-left-square-fill"></i> Kembali ke Dashboard
                </a>
                {% for topik in semua_topik %}
                <div class="list-group-item">
                    <h6 class="mb-1">{{ topik.judul }}</h6>
                    <div class="list-group list-group-flush ps-2">
                        {% for subtopik in topik.subtopik_set.all %}
                        <a href="{% url 'subtopik_detail' pk=subtopik.pk %}"
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-center {% if subtopik.id == subtopik_aktif.id %}active{% endif %}">
                            {{ subtopik.judul }}
                            {% if subtopik.id in completed_materi_ids %}
                            <i class="bi bi-check-circle-fill text-success" title="Telah Selesai"></i>
                            {% endif %}
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
                
                <div class="p-3 mt-auto">
                    <hr>
                    <small class="fw-bold text-muted">Progres Misi (Kuis)</small>
                    <div class="progress mt-1" style="height: 10px;">
                        <div class="progress-bar bg-success" role="progressbar"
                            style="width: {{ progres_misi_persen }}%;" aria-valuenow="{{ progres_misi_persen }}"
                            aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-1 mb-2">
                        <small class="text-muted">{{ kuis_selesai_count }} dari {{ total_subtopik_misi }} kuis selesai.</small>
                        <small class="fw-bold text-success">{{ progres_misi_persen|floatformat:0 }}%</small>
                    </div>

                    {% if kuis_selesai_list %}
                        <div class="mt-3">
                            <small class="text-muted d-block mb-1">Riwayat Penyelesaian:</small>
                            <ul class="list-group list-group-flush small">
                                {% for hasil in kuis_selesai_list %}
                                    <li class="list-group-item px-0 py-1 bg-transparent border-0 d-flex align-items-center">
                                        <i class="bi bi-check-circle-fill text-success me-2"></i>
                                        <span class="text-truncate">{{ hasil.kuis.judul }}</span>
                                        <span class="badge bg-light text-dark ms-auto border">{{ hasil.skor|floatformat:0 }}</span>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                </div>
                </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <h2 class="border-bottom pb-2 mb-3">{{ subtopik_aktif.judul }}</h2>

                <div class="materi-content">
                    {{ subtopik_aktif.konten|safe }}
                </div>

                {% if subtopik_aktif.judul == "1.1: Mengenal Penghuni Lahan Basah" %}
                <div class="card text-dark mt-4">
                    <div class="card-header bg-warning">
                        <h4 class="mb-0">Uji Pemahaman Cepat: Klasifikasi Komponen</h4>
                    </div>
                    <div class="card-body">
                        <p>Seret setiap item di bawah ini ke dalam kotak yang benar, lalu tekan tombol "Cek Jawaban".
                        </p>
                        <div id="items-container" class="d-flex flex-wrap p-2 border rounded mb-3"></div>
                        <div class="row">
                            <div class="col">
                                <div id="biotik" class="p-4 border rounded bg-light text-center drop-zone"
                                    style="min-height: 150px;">
                                    <h5>Biotik</h5>
                                </div>
                            </div>
                            <div class="col">
                                <div id="abiotik" class="p-4 border rounded bg-light text-center drop-zone"
                                    style="min-height: 150px;">
                                    <h5>Abiotik</h5>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-3"><button id="check-button" class="btn btn-primary">Cek
                                Jawaban</button>
                            <div id="result-container" class="mt-2 fw-bold"></div>
                        </div>
                    </div>
                </div>
                
                <div class="card border-primary shadow-lg my-5">
                    <div class="card-header bg-primary text-white">
                        <h3><i class="bi bi-joystick"></i> Tugas dan Aktivitas di EkoSphere</h3>
                    </div>
                    <div class="card-body">
                        <p class="card-text">Untuk memperkuat pemahaman Anda, selesaikan tugas berikut di platform EkoSphere:</p>
                        <ul class="list-group">
                            <li class="list-group-item"><strong>Pelajari Modul Interaktif:</strong> Pastikan Anda telah membaca dan memahami seluruh materi di halaman ini.</li>
                            <li class="list-group-item"><strong>Selesaikan Tantangan:</strong> Masuk ke "Arena Interaktif" dan taklukkan mini-game <strong>"Klasifikasi Komponen Rawa"</strong>. Seret setiap item ke dalam kategori yang tepat!</li>
                        </ul>
                        <div class="text-center mt-4">
                             <a href="{% url 'klasifikasi_arena' %}" class="btn btn-primary btn-lg">Masuk ke Arena Interaktif</a>
                        </div>
                    </div>
                </div>
                
                {% elif subtopik_aktif.judul == "1.2: Membedah Interaksi Makhluk Hidup di Rawa" %}
                <div class="card border-primary shadow-lg my-5">
                    <div class="card-header bg-primary text-white">
                        <h3><i class="bi bi-joystick"></i> D. Tugas dan Aktivitas di EkoSphere</h3>
                    </div>
                    <div class="card-body">
                        <p class="card-text">Lanjutkan "Ekspedisi Rawa Gambut" Anda di platform EkoSphere dengan
                            menyelesaikan tugas berikut:</p>
                        <ul class="list-group">
                            <li class="list-group-item"><strong>Pelajari Modul Interaktif:</strong> Pastikan Anda telah
                                membaca dan memahami seluruh materi di halaman ini.</li>
                            <li class="list-group-item"><strong>Masuk ke Arena Interaktif:</strong> Uji kecepatan dan
                                ketepatan analisis Anda dengan memainkan:
                                <ul>
                                    <li>"Duel Simbiosis Kalsel"</li>
                                    <li>"Jejak Predator Rawa"</li>
                                </ul>
                            </li>
                        </ul>
                        <div class="text-center mt-4">
                            <a href="{% url 'duel_simbiosis' %}" class="btn btn-primary btn-lg mx-2">Mulai Duel
                                Simbiosis</a>
                            <a href="{% url 'jejak_predator' %}" class="btn btn-warning btn-lg mx-2">Mulai Jejak
                                Predator</a>
                        </div>
                    </div>
                </div>

                {% elif subtopik_aktif.judul == "1.3: Membangun Jaring-jaring Makanan Lahan Basah" %}
                
                <div class="card border-primary shadow-lg my-5">
                    <div class="card-header bg-primary text-white">
                        <h3><i class="bi bi-joystick"></i> D. Tugas dan Aktivitas di EkoSphere</h3>
                    </div>
                    <div class="card-body">
                        <p class="card-text">Untuk memperkuat pemahaman Anda, selesaikan tugas berikut di platform EkoSphere:</p>
                        <ul class="list-group">
                            <li class="list-group-item"><strong>Pelajari Modul Interaktif:</strong> Pastikan Anda telah membaca dan memahami seluruh materi di halaman ini.</li>
                            <li class="list-group-item"><strong>Selesaikan Tantangan:</strong> Masuk ke "Arena Interaktif" dan taklukkan "Simulasi: Energy Flow Builder"!</li>
                        </ul>
                        <div class="text-center mt-4">
                             <a href="{% url 'energy_flow_arena' %}" class="btn btn-info btn-lg">Mulai Simulasi Energy Flow Builder</a>
                        </div>
                    </div>
                </div>
                
                {% endif %}
                
                <hr>
                <div class="text-center my-4">
                    {% if is_materi_selesai %}
                    <p class="text-success fw-bold">Anda telah menyelesaikan materi ini.</p>
                    <a href="{% url 'batalkan_materi_selesai' subtopik_aktif.pk %}" class="btn btn-outline-danger">
                        Batalkan Selesai
                    </a>
                    {% else %}
                    <p>Setelah Anda memahami materi ini, tandai sebagai selesai.</p>
                    <a href="{% url 'tandai_materi_selesai' subtopik_aktif.pk %}" class="btn btn-success btn-lg">
                        âœ… Tandai Telah Selesai
                    </a>
                    {% endif %}
                </div>

            </div>

            <div class="card-footer d-flex justify-content-center align-items-center">
                {% if subtopik_sebelumnya %}
                <a href="{% url 'subtopik_detail' pk=subtopik_sebelumnya.pk %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Sebelumnya
                </a>
                {% else %}
                <a href="#" class="btn btn-secondary disabled"><i class="bi bi-arrow-left"></i> Sebelumnya</a>
                {% endif %}
                
                {% if subtopik_aktif.kuis %}
                <a href="{% url 'kuis' pk=subtopik_aktif.pk %}" class="btn btn-primary btn-lg mx-3">Mulai Kuis!</a>
                {% endif %}
                
                {% if subtopik_selanjutnya %}
                <a href="{% url 'subtopik_detail' pk=subtopik_selanjutnya.pk %}" class="btn btn-secondary">
                    Selanjutnya <i class="bi bi-arrow-right"></i>
                </a>
                {% else %}
                <a href="#" class="btn btn-secondary disabled">Selanjutnya <i class="bi bi-arrow-right"></i></a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if subtopik_aktif.judul == "1.1: Mengenal Penghuni Lahan Basah" %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const itemsContainer = document.getElementById('items-container');
        const dropZones = document.querySelectorAll('.drop-zone');
        const checkButton = document.getElementById('check-button');
        const resultContainer = document.getElementById('result-container');
        let draggedItem = null;

        fetch("{% url 'api_klasifikasi' %}")
            .then(response => response.json())
            .then(data => {
                if (data.items) {
                    data.items.forEach(itemData => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'p-2 m-1 border rounded bg-white draggable-item';
                        itemDiv.innerText = itemData.nama;
                        itemDiv.draggable = true;
                        itemDiv.dataset.type = itemData.tipe;
                        itemsContainer.appendChild(itemDiv);
                        itemDiv.addEventListener('dragstart', function (e) {
                            draggedItem = e.target;
                        });
                    });
                }
            });

        dropZones.forEach(zone => {
            zone.addEventListener('dragover', e => e.preventDefault());
            zone.addEventListener('drop', e => {
                e.preventDefault();
                if (draggedItem) {
                    zone.appendChild(draggedItem);
                    draggedItem = null;
                }
            });
        });

        checkButton.addEventListener('click', function () {
            let totalBenar = 0;
            let totalItem = document.querySelectorAll('.draggable-item').length;

            dropZones.forEach(zone => {
                const itemsInZone = zone.querySelectorAll('.draggable-item');
                itemsInZone.forEach(item => {
                    if (item.dataset.type === zone.id) {
                        item.style.backgroundColor = '#d4edda';
                        totalBenar++;
                    } else {
                        item.style.backgroundColor = '#f8d7da';
                    }
                });
            });

            if (totalBenar === totalItem) {
                resultContainer.innerHTML = '<span class="text-success">Hebat! Semua jawabanmu benar!</span>';
            } else {
                resultContainer.innerHTML = `<span class="text-danger">Oops! Kamu benar ${totalBenar} dari ${totalItem} item. Coba perbaiki!</span>`;
            }
        });
    });
</script>
{% elif subtopik_aktif.judul == "1.2: Membedah Interaksi Makhluk Hidup di Rawa" %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        if (!document.getElementById('infoBox')) {
            const infoBoxDiv = document.createElement('div');
            infoBoxDiv.id = 'infoBox';
            infoBoxDiv.className = 'alert alert-info text-center mt-4';
            infoBoxDiv.style.display = 'none';
            document.querySelector('.col-md-8 .card-body').appendChild(infoBoxDiv);
        }

        document.querySelectorAll('.interaktif-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const infoBox = document.getElementById('infoBox');
                infoBox.style.display = 'block';
                infoBox.textContent = btn.dataset.info;
                infoBox.classList.add('animate__animated', 'animate__fadeIn');
                setTimeout(() => infoBox.classList.remove('animate__fadeIn'), 800);
            });
        });
    });
</script>
{% endif %}

{% endblock %}